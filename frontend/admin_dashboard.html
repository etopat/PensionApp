<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Security Meta Tags -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <title>Admin Dashboard - PensionsGo Management System</title>
    
    <!-- CSS Imports -->
    <link rel="stylesheet" href="../frontend/css/color-variables.css">
    <link rel="stylesheet" href="../frontend/css/admin-dashboard.css">
    <link rel="stylesheet" href="../frontend/css/styles.css">
    <link rel="stylesheet" href="../frontend/css/auth.css">
    <link rel="stylesheet" href="../frontend/css/profile.css">
    <link rel="stylesheet" href="../frontend/css/overlay.css">
    <link rel="stylesheet" href="../frontend/css/broadcast_popup.css">
    <link rel="stylesheet" href="../frontend/css/menu.css">
    <link rel="stylesheet" href="../frontend/css/admin-dashboard/user-activity-logs.css">
    <link rel="stylesheet" href="../frontend/css/admin-dashboard/mobile-sidebar.css">
</head>
<body>
    <!-- Security Overlay (Hidden by default) -->
    <div id="securityOverlay" class="security-overlay" style="display: none;">
        <div class="security-modal">
            <div class="security-icon">üîí</div>
            <h3>Security Verification Required</h3>
            <p id="securityMessage">Please verify your identity to access admin features</p>
            <div class="security-actions">
                <button id="verifyAdmin" class="security-btn security-btn-primary">
                    <span class="btn-text">Verify as Admin</span>
                    <span class="btn-spinner" style="display: none;">üîÑ</span>
                </button>
                <button id="cancelAccess" class="security-btn security-btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Admin Access Denied Overlay -->
    <div id="adminAccessDenied" class="access-denied-overlay" style="display: none;">
        <div class="access-denied-content">
            <div class="access-denied-icon">üö´</div>
            <h2>Admin Access Required</h2>
            <p>You do not have the required administrator privileges to access this dashboard.</p>
            <p class="access-denied-details">This area is restricted to users with the 'admin' role only.</p>
            <div class="access-denied-actions">
                <button id="goToDashboard" class="access-denied-btn">Go to Dashboard</button>
                <button id="logoutFromDenied" class="access-denied-btn secondary">Logout</button>
            </div>
        </div>
    </div>

    <!-- Main Admin Dashboard Structure -->
    <div id="adminDashboard" class="admin-dashboard" style="display: none;">
        <!-- Admin Main Content -->
        <main class="admin-main">
            <!-- Admin Sidebar Navigation -->
            <aside class="admin-sidebar" id="adminSidebar">
                <div class="sidebar-header">
                    <div class="admin-brand">
                        <div class="brand-icon">‚öôÔ∏è</div>
                        <h2>Admin Console</h2>
                    </div>
                    <div class="admin-info">
                        <div class="admin-avatar" id="adminAvatar">
                            <img src="../backend/uploads/profiles/default-user.png" alt="Admin Avatar" onerror="this.src='../images/default-user.png'">
                        </div>
                        <div class="admin-details">
                            <span class="admin-name" id="adminName">Loading...</span>
                            <span class="admin-role" id="adminRole">Administrator</span>
                        </div>
                    </div>
                </div>

                <nav class="sidebar-nav">
                    <ul class="nav-menu">
                        <!-- Dashboard Overview -->
                        <li class="nav-item">
                            <a href="#dashboard" class="nav-link active" data-section="dashboard">
                                <span class="nav-icon">üìä</span>
                                <span class="nav-text">Dashboard Overview</span>
                            </a>
                        </li>

                        <!-- User Management -->
                        <li class="nav-item">
                            <a href="#user-management" class="nav-link" data-section="user-management">
                                <span class="nav-icon">üë•</span>
                                <span class="nav-text">User Management</span>
                                <span class="nav-badge" id="userCountBadge">0</span>
                            </a>
                        </li>

                        <!-- System Settings -->
                        <li class="nav-item has-submenu">
                            <a href="#system-settings" class="nav-link" data-section="system-settings">
                                <span class="nav-icon">‚öôÔ∏è</span>
                                <span class="nav-text">System Settings</span>
                                <span class="nav-arrow">‚ñº</span>
                            </a>
                            <ul class="submenu">
                                <li><a href="#app-settings" class="submenu-link" data-section="app-settings">App Settings</a></li>
                                <li><a href="#security-settings" class="submenu-link" data-section="security-settings">Security Settings</a></li>
                                <li><a href="#notification-settings" class="submenu-link" data-section="notification-settings">Notifications</a></li>
                            </ul>
                        </li>

                        <!-- Data Management -->
                        <li class="nav-item has-submenu">
                            <a href="#data-management" class="nav-link" data-section="data-management">
                                <span class="nav-icon">üíæ</span>
                                <span class="nav-text">Data Management</span>
                                <span class="nav-arrow">‚ñº</span>
                            </a>
                            <ul class="submenu">
                                <li><a href="#data-backup" class="submenu-link" data-section="data-backup">Backup & Restore</a></li>
                                <li><a href="#data-export" class="submenu-link" data-section="data-export">Export Data</a></li>
                                <li><a href="#data-import" class="submenu-link" data-section="data-import">Import Data</a></li>
                                <li><a href="#data-cleanup" class="submenu-link" data-section="data-cleanup">Data Cleanup</a></li>
                            </ul>
                        </li>

                        <!-- Storage Management -->
                        <li class="nav-item has-submenu">
                            <a href="#storage-management" class="nav-link" data-section="storage-management">
                                <span class="nav-icon">üíΩ</span>
                                <span class="nav-text">Storage Management</span>
                                <span class="nav-arrow">‚ñº</span>
                            </a>
                            <ul class="submenu">
                                <li><a href="#storage-overview" class="submenu-link" data-section="storage-overview">Storage Overview</a></li>
                                <li><a href="#message-storage" class="submenu-link" data-section="message-storage">Message Storage</a></li>
                                <li><a href="#attachment-storage" class="submenu-link" data-section="attachment-storage">Attachments</a></li>
                                <li><a href="#storage-cleanup" class="submenu-link" data-section="storage-cleanup">Cleanup Tools</a></li>
                            </ul>
                        </li>

                        <!-- Activity Logs -->
                        <li class="nav-item has-submenu">
                            <a href="#activity-logs" class="nav-link" data-section="activity-logs">
                                <span class="nav-icon">üìã</span>
                                <span class="nav-text">Activity Logs</span>
                                <span class="nav-badge" id="logCountBadge">0</span>
                                <span class="nav-arrow">‚ñº</span>
                            </a>
                            <ul class="submenu">
                                <li><a href="#user-logs" class="submenu-link" data-section="user-logs">User Activity Logs</a></li>
                                <li><a href="#workflow-logs" class="submenu-link" data-section="workflow-logs">Workflow Reports</a></li>
                                <li><a href="#task-logs" class="submenu-link" data-section="task-logs">Task Delegation</a></li>
                                <li><a href="#system-logs" class="submenu-link" data-section="system-logs">System Logs</a></li>
                            </ul>
                        </li>

                        <!-- Analysis & Reporting -->
                        <li class="nav-item">
                            <a href="#analysis-reporting" class="nav-link" data-section="analysis-reporting">
                                <span class="nav-icon">üìà</span>
                                <span class="nav-text">Analysis & Reporting</span>
                            </a>
                        </li>

                        <!-- Audit Trail -->
                        <li class="nav-item">
                            <a href="#audit-trail" class="nav-link" data-section="audit-trail">
                                <span class="nav-icon">üîç</span>
                                <span class="nav-text">Audit Trail</span>
                            </a>
                        </li>

                        <!-- System Health -->
                        <li class="nav-item">
                            <a href="#system-health" class="nav-link" data-section="system-health">
                                <span class="nav-icon">‚ù§Ô∏è</span>
                                <span class="nav-text">System Health</span>
                                <span class="health-indicator" id="systemHealthIndicator">‚óè</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <div class="sidebar-footer">
                    <div class="system-status">
                        <div class="status-item">
                            <span class="status-label">Last Backup</span>
                            <span class="status-value" id="lastBackupTime">Never</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Active Users</span>
                            <span class="status-value" id="activeUsersCount">0</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Admin Content Area -->
            <section class="admin-content">
                <div class="content-header">
                    <div class="breadcrumb">
                        <span class="breadcrumb-item">Admin Console</span>
                        <span class="breadcrumb-separator">/</span>
                        <span class="breadcrumb-item active" id="currentSection">Dashboard Overview</span>
                    </div>
                    <div class="content-actions">
                        <button id="refreshData" class="action-btn" title="Refresh Data">
                            <span class="action-icon">üîÑ</span>
                            Refresh
                        </button>
                        <button id="exportData" class="action-btn" title="Export Current View">
                            <span class="action-icon">üì•</span>
                            Export
                        </button>
                        <div class="admin-search">
                            <input type="text" id="adminSearch" placeholder="Search admin features..." class="search-input">
                            <span class="search-icon">üîç</span>
                        </div>
                    </div>
                </div>

                <div class="content-body" id="contentBody">
                    <!-- Content will be dynamically loaded based on section selection -->
                    <div class="welcome-message">
                        <div class="welcome-icon">üëã</div>
                        <h1>Welcome to Admin Console</h1>
                        <p>Select a section from the sidebar to manage system settings and view reports.</p>
                        <div class="welcome-stats">
                            <div class="stat-card">
                                <div class="stat-icon">üë•</div>
                                <div class="stat-info">
                                    <span class="stat-value" id="welcomeUserCount">0</span>
                                    <span class="stat-label">Total Users</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">üìã</div>
                                <div class="stat-info">
                                    <span class="stat-value" id="welcomeLogCount">0</span>
                                    <span class="stat-label">Today's Logs</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">‚ö°</div>
                                <div class="stat-info">
                                    <span class="stat-value" id="welcomeActiveSessions">0</span>
                                    <span class="stat-label">Active Sessions</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- JavaScript Imports -->
    <script type="module" src="../frontend/js/main.js"></script>
    <script src="../frontend/js/admin-dashboard.js"></script>
    <script src="../frontend/js/security-admin.js"></script>
    <!-- <script src="../frontend/js/security.js"></script> -->

    <!-- Simple initialization script -->
    <script>
    // Simple initialization to ensure dashboard loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Admin dashboard page loaded');
        
        // Check if adminDashboard was initialized
        setTimeout(function() {
            if (!window.adminDashboard) {
                console.warn('AdminDashboard not auto-initialized, checking admin access manually...');
                checkAdminAccessManually();
            }
        }, 1000);
    });

    function checkAdminAccessManually() {
        fetch('../backend/api/verify_admin.php', {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.is_admin) {
                document.getElementById('adminDashboard').style.display = 'block';
                document.getElementById('securityOverlay').style.display = 'none';
                
                // Update basic info
                const currentUser = JSON.parse(localStorage.getItem('loggedInUser') || '{}');
                document.getElementById('adminName').textContent = currentUser.name || 'Administrator';
                
                console.log('‚úÖ Admin access verified manually');
            } else {
                document.getElementById('adminAccessDenied').style.display = 'flex';
            }
        })
        .catch(error => {
            console.error('Manual admin verification failed:', error);
            document.getElementById('securityOverlay').style.display = 'flex';
        });
    }

    // Setup security overlay buttons
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('verifyAdmin')?.addEventListener('click', function() {
            location.reload();
        });

        document.getElementById('cancelAccess')?.addEventListener('click', function() {
            window.location.href = 'dashboard.html';
        });

        document.getElementById('goToDashboard')?.addEventListener('click', function() {
            window.location.href = 'dashboard.html';
        });

        document.getElementById('logoutFromDenied')?.addEventListener('click', function() {
            window.location.href = '../backend/api/logout.php';
        });
    });
    </script>
</body>
</html>